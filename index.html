<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Telegram WebApp JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: var(--tg-theme-bg-color, #111);
      color: var(--tg-theme-text-color, #fff);
      padding: 12px;
    }

    .app {
      max-width: 900px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 12px;
    }

    header h1 {
      font-size: 20px;
      margin-bottom: 4px;
    }

    header p {
      font-size: 13px;
      opacity: 0.8;
    }

    .search {
      margin: 12px 0;
      display: flex;
      gap: 8px;
    }

    .search input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      outline: none;
      background: var(--tg-theme-secondary-bg-color, #1d1d1d);
      color: inherit;
      font-size: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
      margin-bottom: 80px;
    }

    .card {
      background: var(--tg-theme-secondary-bg-color, #151515);
      border-radius: 16px;
      padding: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card-img {
      border-radius: 12px;
      padding-top: 60%;
      position: relative;
      overflow: hidden;
      background: radial-gradient(circle at top, #444, #222);
      background-size: cover;
      background-position: center;
    }

    .card-img span {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      opacity: 0.7;
      backdrop-filter: blur(2px);
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      line-height: 1.2;
    }

    .card-subtitle {
      font-size: 11px;
      opacity: 0.8;
    }

    .card-desc {
      font-size: 11px;
      opacity: 0.7;
      line-height: 1.3;
    }

    .card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.09);
      white-space: nowrap;
    }

    .badge-out {
      background: rgba(255, 77, 77, 0.15);
      border-color: rgba(255, 77, 77, 0.6);
      color: #ff9b9b;
    }

    .card-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
      gap: 6px;
    }

    .price-wrap {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .price {
      font-size: 14px;
      font-weight: 600;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: var(--tg-theme-button-color, #2ea6ff);
      color: var(--tg-theme-button-text-color, #fff);
      transition: transform 0.08s ease, opacity 0.08s ease;
      white-space: nowrap;
    }

    .btn:active {
      transform: scale(0.97);
      opacity: 0.85;
    }

    .btn[disabled] {
      opacity: 0.4;
      cursor: default;
      background: #555;
    }

    .cart-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 12px 14px;
      background: color-mix(in srgb, var(--tg-theme-secondary-bg-color, #151515) 94%, #000 6%);
      box-shadow: 0 -4px 16px rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      z-index: 10;
    }

    .cart-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .cart-line1 {
      font-size: 13px;
      font-weight: 600;
    }

    .cart-line2 {
      font-size: 11px;
      opacity: 0.8;
    }

    .cart-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .chip span {
      opacity: 0.7;
    }

    .empty {
      margin-top: 40px;
      text-align: center;
      opacity: 0.6;
      font-size: 13px;
    }

    .loader {
      margin-top: 40px;
      text-align: center;
      opacity: 0.8;
      font-size: 13px;
    }

    @media (max-width: 480px) {
      header h1 {
        font-size: 18px;
      }
      .grid {
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>
      <p>–î–∞–Ω–Ω—ã–µ –±–µ—Ä—É—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ Google Sheets –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.</p>
    </header>

    <div class="search">
      <input id="searchInput" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –º–æ–¥–µ–ª–∏, —Ü–≤–µ—Ç—É, –ø–∞–º—è—Ç–∏, –∫–æ–¥—É..." />
    </div>

    <div id="loader" class="loader">–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ Google Sheets‚Ä¶</div>
    <div id="catalog" class="grid" style="display:none;"></div>
    <div id="emptyLabel" class="empty" style="display:none;">
      –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üßê
    </div>
  </div>

  <div class="cart-bar" id="cartBar" style="display:none;">
    <div class="cart-info">
      <div class="cart-line1" id="cartTitle">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
      <div class="cart-line2" id="cartSubtitle">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É</div>
    </div>
    <div class="cart-actions">
      <div class="chip">
        <strong id="cartTotal">0 ‚ÇΩ</strong>
        <span id="cartCount">(0 —à—Ç.)</span>
      </div>
      <button class="btn" id="sendOrderBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp || null;
    if (tg) {
      tg.expand();
      tg.enableClosingConfirmation();
      tg.MainButton.hide();
    }

    // ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò GOOGLE SHEETS ‚Äî –í–°–¢–ê–í–¨ –°–í–û–Å
    const GOOGLE_SHEET_ID = "–í–°–¢–ê–í–¨_–°–Æ–î–ê_ID_–¢–ê–ë–õ–ò–¶–´"; // <= –ø–æ–º–µ–Ω—è–π
    const SHEET_NAME = "Catalog"; // –∏–º—è –ª–∏—Å—Ç–∞

    function buildSheetUrl() {
      const base = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq`;
      const params = new URLSearchParams({
        tqx: "out:json",
        sheet: SHEET_NAME,
        rand: Date.now().toString(), // –≤—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
      });
      return `${base}?${params.toString()}`;
    }

    let PRODUCTS = [];

    const state = {
      cart: {} // code -> { product, qty }
    };

    const catalogEl = document.getElementById('catalog');
    const searchInput = document.getElementById('searchInput');
    const emptyLabel = document.getElementById('emptyLabel');
    const cartBar = document.getElementById('cartBar');
    const cartTitle = document.getElementById('cartTitle');
    const cartSubtitle = document.getElementById('cartSubtitle');
    const cartTotal = document.getElementById('cartTotal');
    const cartCount = document.getElementById('cartCount');
    const sendOrderBtn = document.getElementById('sendOrderBtn');
    const loaderEl = document.getElementById('loader');

    function formatPrice(value) {
      const num = Number(value) || 0;
      return num.toLocaleString('ru-RU') + ' ‚ÇΩ';
    }

    function parseGoogleSheetJson(rawText) {
      // Google –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç /**/google.visualization.Query.setResponse({...});
      const start = rawText.indexOf('{');
      const end = rawText.lastIndexOf('}');
      const jsonStr = rawText.slice(start, end + 1);
      const obj = JSON.parse(jsonStr);
      const rows = obj.table.rows || [];
      const cols = obj.table.cols || [];

      const colIndex = {};
      cols.forEach((col, idx) => {
        if (!col.label) return;
        const key = col.label.trim().toLowerCase();
        colIndex[key] = idx;
      });

      function getCell(row, label) {
        const idx = colIndex[label.toLowerCase()];
        if (idx === undefined) return null;
        const cellObj = row.c[idx];
        return cellObj ? cellObj.v : null;
      }

      const products = [];

      for (const row of rows) {
        const c = row.c || [];

        const code = getCell(row, '–∫–æ–¥ —Ç–æ–≤–∞—Ä–∞');
        const category = getCell(row, '–∫–∞—Ç–µ–≥–æ—Ä–∏—è');
        const model = getCell(row, '–≤–∏–¥ —Ç–æ–≤–∞—Ä–∞');
        const desc = getCell(row, '–æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞');
        const color = getCell(row, '—Ü–≤–µ—Ç');
        const memory = getCell(row, '–ø–∞–º—è—Ç—å');
        const priceVal = getCell(row, '—Å—Ç–æ–∏–º–æ—Å—Ç—å');
        const stockVal = getCell(row, '–Ω–∞–ª–∏—á–∏–µ');
        const imageUrl = getCell(row, '—Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞');

        if (!code && !model) continue;

        // –Ω–∞–ª–∏—á–∏–µ
        let stock = 0;
        if (typeof stockVal === 'number') {
          stock = stockVal;
        } else if (typeof stockVal === 'string') {
          if (/–Ω–µ—Ç/i.test(stockVal)) {
            stock = 0;
          } else {
            stock = 1;
          }
        }
        const isAvailable = stock > 0;

        const product = {
          code: String(code || '').trim(),
          category: String(category || '').trim(),
          model: String(model || '').trim(),
          description: String(desc || '').trim(),
          color: String(color || '').trim(),
          memory: String(memory || '').trim(),
          price: priceVal !== null && priceVal !== '' ? Number(priceVal) : 0,
          stock,
          isAvailable,
          imageUrl: String(imageUrl || '').trim()
        };

        products.push(product);
      }

      return products;
    }

    async function loadProductsFromSheet() {
      loaderEl.style.display = 'block';
      catalogEl.style.display = 'none';
      emptyLabel.style.display = 'none';

      try {
        const url = buildSheetUrl();
        const res = await fetch(url, { cache: 'no-store' });
        const text = await res.text();
        PRODUCTS = parseGoogleSheetJson(text);
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Google Sheets:', err);
        loaderEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Google Sheets üòî';
        return;
      }

      loaderEl.style.display = 'none';
      catalogEl.style.display = 'grid';

      renderCatalog();
    }

    function productMatchesQuery(product, query) {
      if (!query) return true;
      const q = query.toLowerCase();
      return (
        product.model.toLowerCase().includes(q) ||
        product.description.toLowerCase().includes(q) ||
        product.color.toLowerCase().includes(q) ||
        product.memory.toLowerCase().includes(q) ||
        product.code.toLowerCase().includes(q) ||
        product.category.toLowerCase().includes(q)
      );
    }

    function renderCatalog() {
      const query = searchInput.value.toLowerCase().trim();
      catalogEl.innerHTML = '';

      const filtered = PRODUCTS.filter(p => productMatchesQuery(p, query));

      if (filtered.length === 0) {
        emptyLabel.style.display = 'block';
      } else {
        emptyLabel.style.display = 'none';
      }

      filtered.forEach(product => {
        const card = document.createElement('div');
        card.className = 'card';

        // –∫–∞—Ä—Ç–∏–Ω–∫–∞
        const img = document.createElement('div');
        img.className = 'card-img';

        if (product.imageUrl) {
          img.style.backgroundImage = `url(${product.imageUrl})`;
        } else {
          const placeholder = document.createElement('span');
          placeholder.textContent = '–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞';
          img.appendChild(placeholder);
        }

        // –∑–∞–≥–æ–ª–æ–≤–æ–∫: –º–æ–¥–µ–ª—å –∏–ª–∏ –∫–æ–¥
        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = product.model || product.code;

        // –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫: —Ü–≤–µ—Ç + –ø–∞–º—è—Ç—å + –∫–æ–¥
        const subtitle = document.createElement('div');
        subtitle.className = 'card-subtitle';
        const parts = [];
        if (product.color) parts.push(product.color);
        if (product.memory) parts.push(product.memory + ' GB');
        if (product.code) parts.push('#' + product.code);
        subtitle.textContent = parts.join(' ‚Ä¢ ');

        card.appendChild(img);
        card.appendChild(title);
        card.appendChild(subtitle);

        // –æ–ø–∏—Å–∞–Ω–∏–µ
        if (product.description) {
          const desc = document.createElement('div');
          desc.className = 'card-desc';
          desc.textContent = product.description;
          card.appendChild(desc);
        }

        // –º–µ—Ç–∞: –∫–∞—Ç–µ–≥–æ—Ä–∏—è + –Ω–∞–ª–∏—á–∏–µ
        const meta = document.createElement('div');
        meta.className = 'card-meta';

        if (product.category) {
          const b1 = document.createElement('span');
          b1.className = 'badge';
          b1.textContent = product.category;
          meta.appendChild(b1);
        }

        const stockBadge = document.createElement('span');
        stockBadge.className = 'badge';
        if (!product.isAvailable) {
          stockBadge.classList.add('badge-out');
          stockBadge.textContent = '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏';
        } else {
          stockBadge.textContent = product.stock ? `–í –Ω–∞–ª–∏—á–∏–∏: ${product.stock}` : '–í –Ω–∞–ª–∏—á–∏–∏';
        }
        meta.appendChild(stockBadge);

        card.appendChild(meta);

        // –Ω–∏–∑: —Ü–µ–Ω–∞ + –∫–Ω–æ–ø–∫–∞
        const bottom = document.createElement('div');
        bottom.className = 'card-bottom';

        const priceWrap = document.createElement('div');
        priceWrap.className = 'price-wrap';

        const price = document.createElement('span');
        price.className = 'price';
        price.textContent = formatPrice(product.price);
        priceWrap.appendChild(price);

        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = product.isAvailable ? '–í –∫–æ—Ä–∑–∏–Ω—É' : '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏';
        btn.disabled = !product.isAvailable;

        btn.addEventListener('click', () => {
          if (!product.isAvailable) return;
          addToCart(product);
        });

        bottom.appendChild(priceWrap);
        bottom.appendChild(btn);

        card.appendChild(bottom);

        catalogEl.appendChild(card);
      });
    }

    function addToCart(product) {
      const key = product.code || product.model;
      const item = state.cart[key] || { product, qty: 0 };
      item.qty += 1;
      state.cart[key] = item;
      updateCartView();
      if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    function calcCartTotals() {
      let totalQty = 0;
      let totalSum = 0;

      Object.values(state.cart).forEach(item => {
        totalQty += item.qty;
        totalSum += item.qty * item.product.price;
      });

      return { totalQty, totalSum };
    }

    function updateCartView() {
      const { totalQty, totalSum } = calcCartTotals();

      if (totalQty === 0) {
        cartBar.style.display = 'none';
        if (tg) tg.MainButton.hide();
        return;
      }

      cartBar.style.display = 'flex';
      cartTitle.textContent = `–í –∫–æ—Ä–∑–∏–Ω–µ: ${totalQty} —à—Ç.`;
      cartSubtitle.textContent = '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –≤ —á–∞—Ç.';
      cartTotal.textContent = formatPrice(totalSum);
      cartCount.textContent = `(${totalQty} —à—Ç.)`;

      if (tg) {
        tg.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑');
        tg.MainButton.show();
      }
    }

    function buildOrderPayload() {
      const items = Object.values(state.cart).map(item => ({
        code: item.product.code,
        category: item.product.category,
        model: item.product.model,
        color: item.product.color,
        memory: item.product.memory,
        qty: item.qty,
        price: item.product.price,
        sum: item.qty * item.product.price
      }));

      const { totalQty, totalSum } = calcCartTotals();

      return {
        type: 'cart_order',
        items,
        totalQty,
        totalSum,
        currency: 'RUB',
        createdAt: new Date().toISOString()
      };
    }

    function sendOrder() {
      const payload = buildOrderPayload();
      const json = JSON.stringify(payload);

      if (tg) {
        tg.sendData(json);
        tg.close();
      } else {
        alert('TG WebApp SDK –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ó–∞–∫–∞–∑: ' + json);
      }
    }

    searchInput.addEventListener('input', renderCatalog);
    sendOrderBtn.addEventListener('click', sendOrder);

    if (tg) {
      tg.onEvent('mainButtonClicked', sendOrder);
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    loadProductsFromSheet();
  </script>
</body>
</html>
