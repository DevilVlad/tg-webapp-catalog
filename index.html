import os
import json
import logging
import asyncio

from dotenv import load_dotenv

from aiogram import Bot, Dispatcher, F
from aiogram.types import (
    Message,
    CallbackQuery,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
    WebAppInfo,
)
from aiogram.filters import CommandStart, Command
from aiogram.enums import ParseMode
from aiogram.client.default import DefaultBotProperties

# ----------------- –ó–∞–≥—Ä—É–∑–∫–∞ .env ----------------- #

load_dotenv()

BOT_TOKEN = os.getenv("BOT_TOKEN")
WEBAPP_URL = os.getenv("WEBAPP_URL")
ORDER_CHAT_ID = os.getenv("ORDER_CHAT_ID")  # id —á–∞—Ç–∞ –¥–ª—è –∑–∞–∫–∞–∑–æ–≤ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º)

if not BOT_TOKEN:
    raise RuntimeError("–ù–µ —É–∫–∞–∑–∞–Ω BOT_TOKEN –≤ .env")

if not WEBAPP_URL:
    raise RuntimeError("–ù–µ —É–∫–∞–∑–∞–Ω WEBAPP_URL –≤ .env")

# –µ—Å–ª–∏ ORDER_CHAT_ID —É–∫–∞–∑–∞–Ω ‚Äî –ø—Ä–∏–≤–æ–¥–∏–º –∫ int, –∏–Ω–∞—á–µ None
ORDER_CHAT_ID_INT = int(ORDER_CHAT_ID) if ORDER_CHAT_ID else None

# ----------------- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ----------------- #

logging.basicConfig(level=logging.INFO)

# ----------------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ ----------------- #

bot = Bot(
    token=BOT_TOKEN,
    default=DefaultBotProperties(parse_mode=ParseMode.HTML)
)
dp = Dispatcher()


# ----------------- –•—ç–Ω–¥–ª–µ—Ä—ã ----------------- #

@dp.message(CommandStart())
async def cmd_start(message: Message):
    """
    /start ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç WebApp –∫–∞—Ç–∞–ª–æ–≥
    """
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥ üõí",
                    web_app=WebAppInfo(url=WEBAPP_URL),
                )
            ]
        ]
    )

    await message.answer(
        "–ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ üëá",
        reply_markup=keyboard,
    )


@dp.message(Command("get_id"))
async def cmd_get_id(message: Message):
    """
    –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: /get_id ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ID —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞.
    –£–¥–æ–±–Ω–æ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å ORDER_CHAT_ID –¥–ª—è .env.
    """
    chat_id = message.chat.id
    await message.answer(f"ID —ç—Ç–æ–≥–æ —á–∞—Ç–∞: <code>{chat_id}</code>")


@dp.callback_query(F.web_app_data)
async def handle_webapp_data(callback_query: CallbackQuery):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏—à–ª–∏ –∏–∑ WebApp —á–µ—Ä–µ–∑ tg.sendData(JSON)

    –û–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç payload (–∏–∑ index.html):

    {
      "type": "cart_order",
      "items": [
        {
          "code": "ip15-256b",
          "category": "iPhone",
          "model": "iPhone 15",
          "color": "Blue",
          "memory": "256",
          "qty": 2,
          "price": 109990,
          "sum": 219980
        },
        ...
      ],
      "totalQty": 3,
      "totalSum": 329970,
      "currency": "RUB",
      "createdAt": "2025-11-19T15:00:00.000Z"
    }
    """
    raw_data = callback_query.web_app_data.data

    try:
        data = json.loads(raw_data)
    except Exception:
        logging.exception("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –∏–∑ WebApp")
        await callback_query.answer("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ üòî", show_alert=True)
        return

    if data.get("type") != "cart_order":
        await callback_query.answer("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö ü§î", show_alert=True)
        return

    total_sum = data.get("totalSum", 0)
    total_qty = data.get("totalQty", 0)
    items = data.get("items", [])
    currency = data.get("currency", "RUB")
    created_at = data.get("createdAt")

    user = callback_query.from_user
    user_part = []
    if user.full_name:
        user_part.append(f"{user.full_name}")
    if user.username:
        user_part.append(f"@{user.username}")
    user_line = " / ".join(user_part) if user_part else f"id {user.id}"

    lines: list[str] = []

    lines.append("<b>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –∏–∑ WebApp</b> üõí")
    lines.append("")
    lines.append(f"<b>–ö–ª–∏–µ–Ω—Ç:</b> {user_line}")
    lines.append(f"<b>User ID:</b> <code>{user.id}</code>")
    if created_at:
        lines.append(f"<b>–°–æ–∑–¥–∞–Ω:</b> <code>{created_at}</code>")
    lines.append("")
    lines.append(f"<b>–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤:</b> {total_qty}")
    lines.append(f"<b>–°—É–º–º–∞:</b> {total_sum} {currency}")
    lines.append("")

    if not items:
        lines.append("‚ö† –í –∑–∞–∫–∞–∑–µ –Ω–µ—Ç –ø–æ–∑–∏—Ü–∏–π (items –ø—É—Å—Ç–æ–π).")
    else:
        lines.append("<b>–ü–æ–∑–∏—Ü–∏–∏:</b>")
        for idx, item in enumerate(items, start=1):
            code = item.get("code") or "-"
            category = item.get("category") or ""
            model = item.get("model") or ""
            color = item.get("color") or ""
            memory = item.get("memory") or ""
            qty = item.get("qty", 0)
            price = item.get("price", 0)
            sum_ = item.get("sum", 0)

            # –°—Ç—Ä–æ–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–∞
            title_parts = []
            if model:
                title_parts.append(model)
            if memory:
                title_parts.append(f"{memory} GB")
            if color:
                title_parts.append(color)
            title_str = " ‚Ä¢ ".join(title_parts) if title_parts else code

            # –î–æ–ø. –∏–Ω—Ñ–∞ (–∫–∞—Ç–µ–≥–æ—Ä–∏—è + –∫–æ–¥)
            meta_parts = []
            if category:
                meta_parts.append(category)
            if code:
                meta_parts.append(f"–∫–æ–¥: {code}")
            meta_str = " | ".join(meta_parts)

            lines.append(
                f"{idx}) <b>{title_str}</b>"
            )
            if meta_str:
                lines.append(f"   <i>{meta_str}</i>")

            lines.append(
                f"   {qty} —à—Ç √ó {price} {currency} = <b>{sum_} {currency}</b>"
            )
            lines.append("")

    text = "\n".join(lines)

    # --- –ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑ ---
    if ORDER_CHAT_ID_INT is not None:
        # –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω ORDER_CHAT_ID –≤ .env ‚Äî –≤—Å–µ–≥–¥–∞ —à–ª—ë–º —Ç—É–¥–∞
        target_chat_id = ORDER_CHAT_ID_INT
    else:
        # –∏–Ω–∞—á–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –≤ —á–∞—Ç, –æ—Ç–∫—É–¥–∞ –æ—Ç–∫—Ä—ã–ª–∏ WebApp
        target_chat_id = (
            callback_query.message.chat.id
            if callback_query.message
            else callback_query.from_user.id
        )

    await bot.send_message(target_chat_id, text)
    await callback_query.answer("–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ", show_alert=False)


# ----------------- –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ----------------- #

async def main():
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
