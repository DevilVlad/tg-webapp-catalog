<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Telegram WebApp JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: var(--tg-theme-bg-color, #111);
      color: var(--tg-theme-text-color, #fff);
      padding: 12px;
    }

    .app {
      max-width: 800px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 12px;
    }

    header h1 {
      font-size: 20px;
      margin-bottom: 4px;
    }

    header p {
      font-size: 13px;
      opacity: 0.8;
    }

    .search {
      margin: 12px 0;
    }

    .search input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      outline: none;
      background: var(--tg-theme-secondary-bg-color, #1d1d1d);
      color: inherit;
      font-size: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 80px; /* –º–µ—Å—Ç–æ –ø–æ–¥ –∫–æ—Ä–∑–∏–Ω—É */
    }

    .card {
      background: var(--tg-theme-secondary-bg-color, #151515);
      border-radius: 16px;
      padding: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card-img {
      background: radial-gradient(circle at top, #444, #222);
      border-radius: 12px;
      padding-top: 60%;
      position: relative;
      overflow: hidden;
    }

    .card-img span {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      opacity: 0.7;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      line-height: 1.2;
    }

    .card-desc {
      font-size: 11px;
      opacity: 0.75;
      line-height: 1.3;
    }

    .card-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
    }

    .price {
      font-size: 14px;
      font-weight: 600;
    }

    .old-price {
      font-size: 11px;
      text-decoration: line-through;
      opacity: 0.6;
      margin-left: 4px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: var(--tg-theme-button-color, #2ea6ff);
      color: var(--tg-theme-button-text-color, #fff);
      transition: transform 0.08s ease, opacity 0.08s ease;
    }

    .btn:active {
      transform: scale(0.97);
      opacity: 0.85;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.15);
      color: inherit;
    }

    .cart-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px 12px 14px;
      background: color-mix(in srgb, var(--tg-theme-secondary-bg-color, #151515) 94%, #000 6%);
      box-shadow: 0 -4px 16px rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      z-index: 10;
    }

    .cart-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .cart-line1 {
      font-size: 13px;
      font-weight: 600;
    }

    .cart-line2 {
      font-size: 11px;
      opacity: 0.8;
    }

    .cart-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .chip span {
      opacity: 0.7;
    }

    .empty {
      margin-top: 40px;
      text-align: center;
      opacity: 0.6;
      font-size: 13px;
    }

    @media (max-width: 480px) {
      header h1 {
        font-size: 18px;
      }
      .grid {
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏–∏, –∞ –ø–æ—Ç–æ–º –Ω–∞–∂–º–∏—Ç–µ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑¬ª –≤–Ω–∏–∑—É.</p>
    </header>

    <div class="search">
      <input id="searchInput" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." />
    </div>

    <div id="catalog" class="grid"></div>
    <div id="emptyLabel" class="empty" style="display:none;">
      –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üßê
    </div>
  </div>

  <div class="cart-bar" id="cartBar" style="display:none;">
    <div class="cart-info">
      <div class="cart-line1" id="cartTitle">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
      <div class="cart-line2" id="cartSubtitle">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–∑–∏–Ω—É</div>
    </div>
    <div class="cart-actions">
      <div class="chip">
        <strong id="cartTotal">0 ‚ÇΩ</strong>
        <span id="cartCount">(0 —à—Ç.)</span>
      </div>
      <button class="btn" id="sendOrderBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp || null;

    if (tg) {
      tg.expand();
      tg.enableClosingConfirmation();
      tg.MainButton.hide();
    }

    // –ü—Ä–∏–º–µ—Ä –∫–∞—Ç–∞–ª–æ–≥–∞ ‚Äî –ø–æ—Ç–æ–º –ø–æ–¥–≥—Ä—É–∑–∏—à—å —Å –±—ç–∫–∞ –∏–ª–∏ –∏–∑ API
    const PRODUCTS = [
      {
        id: 'chair1',
        title: '–ò–≥—Ä–æ–≤–æ–µ –∫—Ä–µ—Å–ª–æ DXRacer Prince',
        description: '–≠—Ä–≥–æ–Ω–æ–º–∏—á–Ω–æ–µ –∫—Ä–µ—Å–ª–æ –¥–ª—è –∫–∏–±–µ—Ä—Å–ø–æ—Ä—Ç–∞ –∏ —Ä–∞–±–æ—Ç—ã.',
        price: 19990,
        oldPrice: 22990
      },
      {
        id: 'chair2',
        title: '–ò–≥—Ä–æ–≤–æ–µ –∫—Ä–µ—Å–ª–æ DXRacer Air',
        description: '–î—ã—à–∞—â–∞—è —Å–µ—Ç–∫–∞, –∫–æ–º—Ñ–æ—Ä—Ç –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–µ—Å—Å–∏—è—Ö.',
        price: 24990
      },
      {
        id: 'mouse1',
        title: '–ò–≥—Ä–æ–≤–∞—è –º—ã—à—å AYDA Pro',
        description: '–õ—ë–≥–∫–∞—è, 8 –∫–Ω–æ–ø–æ–∫, RGB.',
        price: 3990
      },
      {
        id: 'kb1',
        title: '–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ TKL',
        description: '–ö—Ä–∞—Å–Ω—ã–µ —Å–≤–∏—Ç—á–∏, –ø–æ–¥—Å–≤–µ—Ç–∫–∞, –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.',
        price: 6990,
        oldPrice: 7490
      },
      {
        id: 'headset1',
        title: '–ì–µ–π–º–µ—Ä—Å–∫–∞—è –≥–∞—Ä–Ω–∏—Ç—É—Ä–∞ 7.1',
        description: '–û–±—ä—ë–º–Ω—ã–π –∑–≤—É–∫ –∏ –º—è–≥–∫–∏–µ –∞–º–±—É—à—é—Ä—ã.',
        price: 5490
      }
    ];

    const state = {
      cart: {} // id -> { product, qty }
    };

    const catalogEl = document.getElementById('catalog');
    const searchInput = document.getElementById('searchInput');
    const emptyLabel = document.getElementById('emptyLabel');
    const cartBar = document.getElementById('cartBar');
    const cartTitle = document.getElementById('cartTitle');
    const cartSubtitle = document.getElementById('cartSubtitle');
    const cartTotal = document.getElementById('cartTotal');
    const cartCount = document.getElementById('cartCount');
    const sendOrderBtn = document.getElementById('sendOrderBtn');

    function formatPrice(value) {
      return value.toLocaleString('ru-RU') + ' ‚ÇΩ';
    }

    function renderCatalog() {
      const query = searchInput.value.toLowerCase().trim();
      catalogEl.innerHTML = '';

      const filtered = PRODUCTS.filter(p =>
        p.title.toLowerCase().includes(query)
      );

      if (filtered.length === 0) {
        emptyLabel.style.display = 'block';
      } else {
        emptyLabel.style.display = 'none';
      }

      filtered.forEach(product => {
        const card = document.createElement('div');
        card.className = 'card';

        const img = document.createElement('div');
        img.className = 'card-img';
        img.innerHTML = '<span>–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞</span>';

        const title = document.createElement('div');
        title.className = 'card-title';
        title.textContent = product.title;

        const desc = document.createElement('div');
        desc.className = 'card-desc';
        desc.textContent = product.description;

        const bottom = document.createElement('div');
        bottom.className = 'card-bottom';

        const priceWrap = document.createElement('div');
        const price = document.createElement('span');
        price.className = 'price';
        price.textContent = formatPrice(product.price);
        priceWrap.appendChild(price);

        if (product.oldPrice) {
          const old = document.createElement('span');
          old.className = 'old-price';
          old.textContent = formatPrice(product.oldPrice);
          priceWrap.appendChild(old);
        }

        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = '–í –∫–æ—Ä–∑–∏–Ω—É';

        btn.addEventListener('click', () => {
          addToCart(product);
        });

        bottom.appendChild(priceWrap);
        bottom.appendChild(btn);

        card.appendChild(img);
        card.appendChild(title);
        card.appendChild(desc);
        card.appendChild(bottom);

        catalogEl.appendChild(card);
      });
    }

    function addToCart(product) {
      const item = state.cart[product.id] || { product, qty: 0 };
      item.qty += 1;
      state.cart[product.id] = item;
      updateCartView();
      if (tg) tg.HapticFeedback.impactOccurred('light');
    }

    function calcCartTotals() {
      let totalQty = 0;
      let totalSum = 0;

      Object.values(state.cart).forEach(item => {
        totalQty += item.qty;
        totalSum += item.qty * item.product.price;
      });

      return { totalQty, totalSum };
    }

    function updateCartView() {
      const { totalQty, totalSum } = calcCartTotals();

      if (totalQty === 0) {
        cartBar.style.display = 'none';
        if (tg) tg.MainButton.hide();
        return;
      }

      cartBar.style.display = 'flex';
      cartTitle.textContent = `–í –∫–æ—Ä–∑–∏–Ω–µ: ${totalQty} —à—Ç.`;
      cartSubtitle.textContent = '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –≤ —á–∞—Ç.';
      cartTotal.textContent = formatPrice(totalSum);
      cartCount.textContent = `(${totalQty} —à—Ç.)`;

      if (tg) {
        tg.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑');
        tg.MainButton.show();
      }
    }

    function buildOrderPayload() {
      const items = Object.values(state.cart).map(item => ({
        id: item.product.id,
        title: item.product.title,
        qty: item.qty,
        price: item.product.price,
        sum: item.qty * item.product.price
      }));

      const { totalQty, totalSum } = calcCartTotals();

      return {
        type: 'cart_order',
        items,
        totalQty,
        totalSum,
        currency: 'RUB',
        createdAt: new Date().toISOString()
      };
    }

    function sendOrder() {
      const payload = buildOrderPayload();
      const json = JSON.stringify(payload);

      if (tg) {
        tg.sendData(json); // –ø—Ä–∏–ª–µ—Ç–∏—Ç –≤ –±–æ—Ç–∞ –≤ callback_query.data (web_app_data)
        tg.close();
      } else {
        alert('TG WebApp SDK –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ó–∞–∫–∞–∑: ' + json);
      }
    }

    searchInput.addEventListener('input', renderCatalog);
    sendOrderBtn.addEventListener('click', sendOrder);

    if (tg) {
      tg.onEvent('mainButtonClicked', sendOrder);
    }

    renderCatalog();
  </script>
</body>
</html>
